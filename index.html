import React, { useState, useRef, useEffect } from 'react';
import { Camera, Download, RefreshCw, Sparkles, Heart, Smile, Coins, Briefcase, Activity, Users, User, MousePointer2 } from 'lucide-react';

// ============================================================
// ğŸ–¼ï¸ åœ–ç‰‡é€£çµå®šç¾©å€ï¼šè«‹åœ¨æ­¤è™•æ›´æ›æ‚¨çš„ PNG åœ–ç‰‡ç¶²å€
// ============================================================

// 1. ç¬¬ä¸€é ä»‹é¢æœ€ä¸Šæ–¹çš„æ’åœ– (ç›®å‰æœƒè·³å‹•çš„é‚£éš»é¦¬)
const HEADER_IMG_URL = "https://img.freepik.com/free-vector/cute-horse-cartoon-vector-icon-illustration-animal-nature-icon-concept-isolated-premium-vector_138676-5412.jpg"; 

// 2. è³€å¡ç”Ÿæˆçš„å››å€‹è§’è½å°æ’åœ– (PNG é€æ˜åº•æ•ˆæœæœ€ä½³)
const CORNER_TOP_LEFT     = "https://img.freepik.com/free-vector/gold-ingot-cartoon-vector-icon-illustration-wealth-concept-isolated-premium-vector_138676-5412.jpg"; // å·¦ä¸Š (é‡‘å…ƒå¯¶)
const CORNER_TOP_RIGHT    = "https://img.freepik.com/free-vector/cute-horse-cartoon-vector-icon-illustration-animal-nature-icon-concept-isolated-premium-vector_138676-5412.jpg"; // å³ä¸Š
const CORNER_BOTTOM_LEFT  = "https://img.freepik.com/free-vector/cute-bird-cartoon-vector-icon-illustration-animal-nature-icon-concept-isolated-premium-vector_138676-5412.jpg"; // å·¦ä¸‹ (1.5å€æ”¾å¤§)
const CORNER_BOTTOM_RIGHT = "https://img.freepik.com/free-vector/sun-icon-vector-isolated-white-background_138676-5412.jpg";                                                     // å³ä¸‹ (1.5å€æ”¾å¤§)

// ============================================================

const PageHeaderIllustration = () => (
  <div className="w-32 h-32 flex items-center justify-center overflow-hidden rounded-full bg-white/20 p-2 border-4 border-white/30 shadow-2xl relative z-10">
    <img 
      src={HEADER_IMG_URL} 
      alt="é¦¬å¹´å‰ç¥¥ç‰©" 
      className="max-w-full max-h-full object-contain"
      onError={(e) => {
        e.target.style.display = 'none';
        e.target.parentNode.innerHTML = '<span class="text-white text-5xl">ğŸ§§</span>';
      }}
    />
  </div>
);

const App = () => {
  const [step, setStep] = useState(1);
  const [selectedWish, setSelectedWish] = useState(null);
  const [randomBlessing, setRandomBlessing] = useState('');
  const [userImage, setUserImage] = useState(null);
  const [userName, setUserName] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [finalImageUrl, setFinalImageUrl] = useState('');
  const canvasRef = useRef(null);

  const luckPhrases = ["é¦¬åˆ°æˆåŠŸ", "é¾é¦¬ç²¾ç¥", "ä¸€é¦¬ç•¶å…ˆ", "è¬é¦¬å¥”é¨°", "ç¥¥é¦¬ç»ç‘", "é‡‘é¦¬è¿æ˜¥", "é¦¬é‹äº¨é€š", "é¦¬åˆ°ç¦éš¨"];

  const wishPool = [
    { id: 'wealth', label: 'è²¡å¯Œ', color: '#FEF3C7', icon: <Coins className="text-amber-600" size={32} />, blessings: ["é¦¬ä¸Šæœ‰éŒ¢ è²¡æºå»£é€²", "é§¿é¦¬å ±å–œ è²¡åº«å……ç›ˆ", "é‡‘é¦¬éŠœå¯¶ è¬äº‹å¤§å‰", "è²¡æ°£äº¨é€š é¦¬é‹ç•¶é ­"] },
    { id: 'career', label: 'äº‹æ¥­', color: '#DBEAFE', icon: <Briefcase className="text-blue-600" size={32} />, blessings: ["é¦¬åˆ°æˆåŠŸ é´»åœ–å¤§å±•", "é©å‹‡å¦‚é¦¬ æ¥­ç¸¾é•·ç´…", "ç­–é¦¬æšé­ æ­¥æ­¥é«˜å‡", "è¬é¦¬å¥”é¨° æ——é–‹å¾—å‹"] },
    { id: 'health', label: 'å¥åº·', color: '#DCFCE7', icon: <Activity className="text-green-600" size={32} />, blessings: ["é¾é¦¬ç²¾ç¥ èº«é«”å¥åº·", "æ´»åŠ›å¦‚é¦¬ å£½æ¯”å—å±±", "ç¥¥é¦¬ç»ç‘ é—”å®¶å®‰åº·", "é¾é¦¬å£¯å¥ ç¦æ°£é€£é€£"] },
    { id: 'love', label: 'æ„›æƒ…', color: '#FFE4E6', icon: <Heart className="text-rose-500" size={32} />, blessings: ["ç­–é¦¬æƒ…æ·± å¹¸ç¦ç¾æ»¿", "é¾é¦¬é›™é£› æ©æ„›ç™¾å¹´", "ç¥¥é¦¬ç¹«ç·£ ç”œèœœä¸€ç”Ÿ", "é§¿é¦¬å¼•è·¯ ç·£å®šä»Šç”Ÿ"] },
    { id: 'marriage', label: 'å©šå§»', color: '#F3E8FF', icon: <Smile className="text-purple-600" size={32} />, blessings: ["å¤©ä½œä¹‹åˆ é¦¬ä¸Šæœ‰å–œ", "é¾é¦¬è‰¯ç·£ ç™¾å¹´å¥½åˆ", "ç¥¥é¦¬å ±å–œ æ°¸çµåŒå¿ƒ", "é‡‘é¦¬é€£ç† æ©æ„›é•·ä¹…"] },
    { id: 'relation', label: 'é—œä¿‚', color: '#FDF2F8', icon: <Users className="text-pink-600" size={32} />, blessings: ["é§¿é¦¬å¼•è·¯ è²´äººç›¸éš¨", "é¾é¦¬åŒè¡Œ ä¼¯æ¨‚è­˜å›", "é§¿é¦¬å¥”é¨° å»£çµå–„ç·£", "é‡‘é¦¬ç‰½ç·š è²´äººç›ˆé–€"] }
  ];

  const handleSelectWish = (wish) => {
    const randomIndex = Math.floor(Math.random() * wish.blessings.length);
    setSelectedWish(wish);
    setRandomBlessing(wish.blessings[randomIndex]);
    setStep(2);
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => { setUserImage(event.target.result); setStep(3); };
      reader.readAsDataURL(file);
    }
  };

  useEffect(() => {
    const generateCard = async () => {
      if (step === 3 && canvasRef.current && userImage && selectedWish) {
        setIsGenerating(true);
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        
        const loadImage = (src) => {
          return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = src;
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
          });
        };

        const [userImg, tl, tr, bl, br] = await Promise.all([
          loadImage(userImage),
          loadImage(CORNER_TOP_LEFT),
          loadImage(CORNER_TOP_RIGHT),
          loadImage(CORNER_BOTTOM_LEFT),
          loadImage(CORNER_BOTTOM_RIGHT)
        ]);

        drawFinalCard(ctx, canvas, { user: userImg, tl, tr, bl, br });
        setFinalImageUrl(canvas.toDataURL('image/png'));
        setIsGenerating(false);
      }
    };

    generateCard();
  }, [step, selectedWish, userImage, randomBlessing, userName]);

  const drawFinalCard = (ctx, canvas, images) => {
    canvas.width = 1000;
    canvas.height = 1800;

    ctx.fillStyle = '#fdfbf7'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    ctx.globalAlpha = 0.95; ctx.fillStyle = '#C8102E'; 
    drawHandDrawnRect(ctx, 40, 40, 920, 1720, 60);
    ctx.fill(); ctx.restore();

    ctx.strokeStyle = 'rgba(253, 230, 138, 0.7)'; ctx.lineWidth = 12; ctx.setLineDash([20, 15]);
    drawHandDrawnRect(ctx, 70, 70, 860, 1660, 40); ctx.stroke(); ctx.setLineDash([]);

    if (images.user) {
      const photoX = 100, photoY = 130, photoW = 800, photoH = 750;
      ctx.save(); drawHandDrawnRect(ctx, photoX, photoY, photoW, photoH, 50); ctx.clip();
      const imgRatio = images.user.width / images.user.height;
      const targetRatio = photoW / photoH;
      let dW, dH, dX, dY;
      if (imgRatio > targetRatio) { dH = photoH; dW = images.user.width * (photoH / images.user.height); dX = photoX - (dW - photoW) / 2; dY = photoY; }
      else { dW = photoW; dH = images.user.height * (photoW / images.user.width); dX = photoX; dY = photoY - (dH - photoH) / 2; }
      ctx.drawImage(images.user, dX, dY, dW, dH); ctx.restore();
    }

    ctx.fillStyle = '#FDE68A'; ctx.textAlign = 'center';
    ctx.font = 'bold 95px "Noto Serif TC", serif'; ctx.fillText(randomBlessing, 500, 1050);
    ctx.font = '38px "Noto Sans TC", sans-serif'; ctx.fillText(`2026 ä¸™åˆé¦¬å¹´ Â· é¡˜æ‚¨${selectedWish.label}å¦‚æ„`, 500, 1140);
    if (userName) { ctx.font = 'bold 50px "Noto Serif TC", serif'; ctx.fillText(`${userName} æ•¬è³€`, 500, 1230); }

    const normSize = 120;
    const largeSize = 180; 
    if (images.tl) ctx.drawImage(images.tl, 100, 100, normSize, normSize);
    if (images.tr) ctx.drawImage(images.tr, 780, 100, normSize, normSize);
    
    const decoY = 1450; 
    if (images.bl) ctx.drawImage(images.bl, 80, decoY, largeSize, largeSize);
    if (images.br) ctx.drawImage(images.br, 740, decoY, largeSize, largeSize);

    const stampY = 1400;
    const filteredPhrases = luckPhrases.filter(p => !randomBlessing.includes(p));
    const luckText = filteredPhrases[Math.floor(Math.random() * filteredPhrases.length)] || "é¦¬åˆ°æˆåŠŸ";
    drawBlob(ctx, 500, stampY, 70, '#FDE68A');
    ctx.fillStyle = '#BE123C'; ctx.font = 'bold 36px "Noto Serif TC", serif';
    ctx.fillText(luckText[0], 480, stampY - 5); ctx.fillText(luckText[1], 520, stampY - 5);
    ctx.fillText(luckText[2], 480, stampY + 35); ctx.fillText(luckText[3], 520, stampY + 35);

    const footerY = 1600;
    ctx.fillStyle = '#e6e39c';
    ctx.font = 'bold 32px "Noto Sans TC", sans-serif'; ctx.fillText("Â© 2026 æ„›ç›Ÿå®¶åº­æ–‡æ•™åŸºé‡‘æœƒ", 500, footerY);
    ctx.font = '28px "Noto Sans TC", sans-serif'; ctx.fillText("ç‚ºæ„›å­¸ç¿’æŒçºŒç·´ç¿’ï¼Œæ˜¯ä¸€ä»¶å¹¸ç¦çš„äº‹", 500, footerY + 50);
  };

  function drawHandDrawnRect(ctx, x, y, w, h, r) {
    const jitter = () => (Math.random() * 4 - 2); 
    const startX = x + r;
    const startY = y;
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(x + w - r + jitter(), y + jitter());
    ctx.quadraticCurveTo(x + w, y, x + w + jitter(), y + r + jitter());
    ctx.lineTo(x + w + jitter(), y + h - r + jitter());
    ctx.quadraticCurveTo(x + w, y + h, x + w - r + jitter(), y + h + jitter());
    ctx.lineTo(x + r + jitter(), y + h + jitter());
    ctx.quadraticCurveTo(x, y + h, x + jitter(), y + h - r + jitter());
    ctx.lineTo(x + jitter(), y + r + jitter());
    ctx.quadraticCurveTo(x, y, startX, startY);
    ctx.closePath();
  }

  function drawBlob(ctx, x, y, r, color) {
    ctx.save(); ctx.globalAlpha = 0.85; ctx.fillStyle = color; ctx.beginPath();
    for(let i=0; i<8; i++) { const angle = (i/8) * Math.PI * 2; const rr = r + (Math.random() * 15 - 7); const px = x + Math.cos(angle) * rr; const py = y + Math.sin(angle) * rr; if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py); }
    ctx.closePath(); ctx.fill(); ctx.restore();
  }

  const downloadImage = () => {
    const link = document.createElement('a');
    link.download = `2026é¦¬å¹´è³€å¡.png`;
    link.href = finalImageUrl;
    link.click();
  };

  return (
    <div className="min-h-screen bg-[#fcf8f2] text-slate-900 font-sans pb-12 select-none">
      <style>{`
        @keyframes handPulse {
          0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
          50% { transform: translateY(8px) scale(0.9); opacity: 0.7; }
        }
        .animate-hand {
          animation: handPulse 1.5s infinite ease-in-out;
        }
      `}</style>
      
      <canvas ref={canvasRef} className="hidden" />

      <header className="bg-red-800 text-yellow-100 pt-12 pb-16 px-6 text-center relative shadow-xl overflow-hidden">
        <div className="relative z-10 flex flex-col items-center gap-2">
          <div className="animate-bounce"><PageHeaderIllustration /></div>
          <h1 className="text-4xl font-bold tracking-[0.2em] drop-shadow-md">2026 ä¸™åˆé¦¬å¹´</h1>
          <p className="text-red-100 mt-2 text-xl font-medium tracking-widest bg-white/10 px-6 py-1 rounded-full border border-white/20 backdrop-blur-sm">æ‰‹ç¹ªæ’ç•«æ„Ÿæ‹œå¹´è³€å¡</p>
        </div>
      </header>

      <main className="max-w-xl mx-auto p-5 -mt-6 relative z-20">
        <div className="flex items-center justify-around mb-12 bg-white/80 backdrop-blur p-4 rounded-3xl shadow-sm border border-red-50">
          {[1, 2, 3].map((num) => (
            <div key={num} className="flex flex-col items-center gap-2">
              <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-bold text-xl transition-all ${step === num ? 'bg-red-600 text-white scale-110 shadow-lg' : step > num ? 'bg-red-100 text-red-700' : 'bg-white border-2 border-red-50 text-red-100'}`}>{num}</div>
              <span className={`text-sm font-bold ${step >= num ? 'text-red-900' : 'text-slate-300'}`}>{num === 1 ? 'è¨±å¿ƒé¡˜' : num === 2 ? 'å‚³ç…§ç‰‡' : 'çœ‹æˆå“'}</span>
            </div>
          ))}
        </div>

        {step === 1 && (
          <div className="animate-in fade-in slide-in-from-bottom-8 duration-500 space-y-8">
            <div className="bg-white/60 p-6 rounded-[2.5rem] border-2 border-red-100 shadow-sm space-y-4">
              <label className="text-xl font-bold text-slate-700 flex items-center gap-2"><User size={24} className="text-red-500" />æƒ³è©¢å•æ‚¨çš„è³€å¡æƒ³è¦æ€éº¼ç½²åï¼Ÿ</label>
              <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" className="w-full p-4 text-xl bg-white border-2 border-red-200 rounded-2xl focus:outline-none focus:border-red-500 transition-colors shadow-inner" />
              <p className="text-slate-400 text-base italic">â€» å°‡æœƒå°è£½åœ¨è³€å¡ä¸‹æ–¹çš„ç¥ç¦èªå¾Œæ–¹</p>
            </div>
            <div className="h-px bg-slate-200 w-full"></div>
            <h2 className="text-2xl font-bold text-center text-slate-800 mb-8 font-serif">æ–°çš„ä¸€å¹´ï¼Œæ‚¨çš„é¡˜æœ›æ˜¯ï¼Ÿ</h2>
            <div className="grid grid-cols-2 gap-5">
              {wishPool.map((wish) => (
                <button key={wish.id} onClick={() => handleSelectWish(wish)} style={{ backgroundColor: wish.color }} className="group p-8 rounded-[2.5rem] shadow-sm hover:shadow-xl transition-all border-2 border-transparent hover:border-red-400 flex flex-col items-center gap-3 relative overflow-hidden active:scale-95">
                  <div className="mb-2 group-hover:scale-125 transition-transform animate-float">{wish.icon}</div>
                  <span className="text-2xl font-bold text-slate-800 tracking-wider">{wish.label}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="animate-in fade-in slide-in-from-bottom-8 duration-500 text-center space-y-8">
            <h2 className="text-2xl font-bold text-center text-slate-800 font-serif">ç‚ºã€Œ{selectedWish?.label}ã€å¿ƒé¡˜æ‹å¼µç…§å§</h2>
            <div className="relative group mx-auto max-w-sm">
              <input type="file" accept="image/*" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
              <div className="bg-white aspect-square rounded-[3.5rem] shadow-xl border-4 border-dashed border-red-100 flex flex-col items-center justify-center gap-6 group-hover:border-red-400 transition-colors p-10">
                <div className="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center"><Camera className="w-12 h-12 text-red-500" /></div>
                <div className="space-y-1"><p className="text-2xl font-bold text-slate-700">é»æ“Šä¸Šå‚³ç…§ç‰‡</p><p className="text-slate-400 text-lg">å»ºè­°é¸å–æ¸…æ™°çš„å…¨å®¶ç¦æˆ–ç¨ç…§</p></div>
              </div>
            </div>
            <button onClick={() => setStep(1)} className="text-slate-400 hover:text-red-700 font-bold text-xl flex items-center justify-center gap-2 mx-auto"><RefreshCw className="w-5 h-5" /> é‡æ–°é¸é¡˜æœ›</button>
          </div>
        )}

        {step === 3 && (
          <div className="animate-in zoom-in-95 duration-700 space-y-10">
            <h2 className="text-2xl font-bold text-center text-red-900 flex items-center justify-center gap-2 font-serif">
              <Sparkles className="text-yellow-600" /> æ‚¨çš„é¦¬å¹´å°ˆå±¬è³€å¡å®Œæˆå›‰ï¼
            </h2>
            
            {/* è³€å¡é è¦½å€åŸŸ */}
            <div className="relative group max-w-[90%] mx-auto">
              <div className="absolute -inset-1 bg-gradient-to-b from-red-100 to-red-50 rounded-[3.2rem] blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
              <div className="relative shadow-2xl rounded-[3rem] overflow-hidden bg-white border-[12px] border-white ring-1 ring-black/5">
                {isGenerating ? (
                  <div className="aspect-[1000/1800] w-full flex flex-col items-center justify-center gap-4 bg-slate-50/50 backdrop-blur-sm">
                    <div className="w-16 h-16 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
                    <p className="font-bold text-red-800 text-xl tracking-widest animate-pulse">ç¹ªè£½è³€å¡ä¸­...</p>
                  </div>
                ) : (
                  <img src={finalImageUrl} alt="æˆå“è³€å¡" className="w-full h-auto block" style={{ WebkitTouchCallout: 'default' }} />
                )}
              </div>
            </div>

            {/* ä¸‹æ–¹äº’å‹•èˆ‡èªªæ˜å€ */}
            <div className="space-y-6">
              <button onClick={downloadImage} className="w-full bg-red-700 text-yellow-50 py-6 rounded-[2.2rem] text-2xl font-bold shadow-[0_10px_20px_-5px_rgba(185,28,28,0.4)] flex items-center justify-center gap-4 hover:bg-red-800 active:scale-95 transition-all">
                <Download className="w-8 h-8" /> å„²å­˜åˆ°æ‰‹æ©Ÿ
              </button>

              {/* ğŸš€ æ”¹è‰¯å¾Œçš„é•·æŒ‰å­˜åœ–æç¤ºæ¡† */}
              <div className="relative overflow-hidden bg-yellow-50/80 border-2 border-dashed border-yellow-300 rounded-[2.5rem] p-8 text-center shadow-inner">
                <div className="relative z-10 flex flex-col items-center gap-3">
                  <div className="bg-yellow-400 text-white p-3 rounded-full animate-hand">
                    <MousePointer2 size={28} />
                  </div>
                  <div className="space-y-1">
                    <p className="text-yellow-950 text-xl font-bold">å°ç§˜è¨£ï¼šé•·æŒ‰ä¸Šæ–¹åœ–ç‰‡</p>
                    <p className="text-yellow-800 text-lg leading-relaxed">
                      å½ˆå‡ºé¸å–®å¾Œé»é¸ã€Œå„²å­˜å½±åƒã€<br/>å³å¯åˆ†äº«åˆ° <b>LINE</b> ç¾¤çµ„èˆ‡è¦ªå‹æ‹œå¹´ï¼
                    </p>
                  </div>
                </div>
                <div className="absolute -right-4 -bottom-4 text-yellow-200/50 -rotate-12">
                   <Sparkles size={80} />
                </div>
              </div>

              <button onClick={() => {setStep(1); setUserName(''); setFinalImageUrl('');}} className="w-full text-slate-400 font-bold text-xl py-4 hover:text-red-700 transition-colors flex items-center justify-center gap-2">
                <RefreshCw size={20} /> è£½ä½œå¦ä¸€å¼µè³€å¹´å¡
              </button>
            </div>
          </div>
        )}
      </main>

      <footer className="mt-12 px-8 max-w-xl mx-auto opacity-70 text-center space-y-4 pb-20">
        <div className="h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent"></div>
        <div className="space-y-3">
          <p className="text-slate-500 font-light text-lg italic tracking-wider">2026 ä¸™åˆé¦¬å¹´ Â· ç¥¥é¦¬ç»ç‘ Â· è¬äº‹å¤§å‰</p>
          <div className="text-slate-400 font-light text-lg italic space-y-1">
            <p>Â© 2026 æ„›ç›Ÿå®¶åº­æ–‡æ•™åŸºé‡‘æœƒ</p>
            <p>ç‚ºæ„›å­¸ç¿’æŒçºŒç·´ç¿’ï¼Œæ˜¯ä¸€ä»¶å¹¸ç¦çš„äº‹</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default App;